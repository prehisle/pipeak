# 智能课程更新脚本使用说明

## 🎯 脚本功能

`update_lessons.py` 是一个安全的课程内容更新脚本，专门用于更新第6课和第7课的显示格式问题。

### ✨ 核心特性

- 🔒 **保持课程ID不变** - 保护用户学习数据
- 🔄 **智能差异检测** - 只更新有变化的内容
- 💾 **自动备份** - 更新前自动备份原始数据
- 🛡️ **用户确认** - 防止误操作
- 📊 **详细报告** - 显示更新结果和统计信息

## 🚀 使用方法

### 方法1：直接运行（推荐）

```bash
cd backend
python update_lessons.py
```

### 方法2：设置环境变量

如果数据库连接信息不同，可以设置环境变量：

```bash
# Windows
set MONGODB_URI=mongodb://your-connection-string
set DB_NAME=your-database-name
python update_lessons.py

# Linux/Mac
export MONGODB_URI=mongodb://your-connection-string
export DB_NAME=your-database-name
python update_lessons.py
```

## 📋 更新内容

脚本将更新以下内容：

### 第6课：矩阵与向量
- 修正矩阵表示法的显示格式
- 从：`$$\begin{matrix}...$$` → 基础矩阵
- 改为：`$$\begin{matrix}...$$` → 渲染的矩阵 (基础矩阵)

### 第7课：方程组与不等式
- 修正方程组表示法的显示格式
- 从：`$$\begin{cases}...$$` → 二元方程组
- 改为：`$$\begin{cases}...$$` → 渲染的方程组 (二元方程组)

## 🔒 安全保障

### 数据保护
- ✅ 课程ID (`_id`) 保持不变
- ✅ 创建时间 (`created_at`) 保持不变
- ✅ 用户学习进度不受影响
- ✅ 只更新 `title`、`description`、`cards`、`updated_at` 字段

### 备份机制
- 📁 自动创建备份文件：`lesson_backup_YYYYMMDD_HHMMSS.json`
- 💾 包含所有要更新的课程的原始数据
- 🔄 可用于回滚操作

### 确认机制
- ⚠️ 显示即将更新的课程列表
- 🤔 要求用户手动确认 (输入 'y' 继续)
- ❌ 可随时取消操作

## 📊 执行流程

1. **连接数据库** - 验证数据库连接
2. **加载更新数据** - 准备新的课程内容
3. **创建备份** - 自动备份原始数据
4. **用户确认** - 显示更新计划，等待确认
5. **差异检测** - 比较现有内容与新内容
6. **执行更新** - 只更新有差异的课程
7. **显示结果** - 报告更新统计信息

## 🔧 故障排除

### 数据库连接失败
```
❌ 数据库连接失败: Authentication failed.
```
**解决方案：**
- 检查数据库服务是否运行
- 验证连接字符串和认证信息
- 设置正确的 `MONGODB_URI` 环境变量

### 权限问题
```
❌ 第X课更新出错: not authorized
```
**解决方案：**
- 确保数据库用户有写入权限
- 检查数据库认证配置

### 备份失败
```
⚠️ 备份失败: Permission denied
```
**解决方案：**
- 确保当前目录有写入权限
- 检查磁盘空间是否充足

## 📈 预期结果

成功执行后，您将看到：

```
🎉 更新完成！
✅ 成功更新: 2 个课程
⏭️ 跳过更新: 0 个课程

💡 提示：课程ID保持不变，用户学习数据不受影响
```

## 🔄 回滚操作

如果需要回滚，可以使用备份文件：

1. 找到生成的备份文件 `lesson_backup_*.json`
2. 使用MongoDB工具或脚本恢复数据
3. 或联系开发人员协助回滚

## ⚠️ 注意事项

- 建议在非高峰时段执行更新
- 确保数据库有足够的存储空间
- 更新前可以先在测试环境验证
- 保留备份文件直到确认更新成功

## 📞 技术支持

如果遇到问题，请：
1. 检查控制台输出的错误信息
2. 查看生成的备份文件
3. 联系开发团队获取支持
